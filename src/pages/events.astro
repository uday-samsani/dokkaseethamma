---
import Layout from '@/layouts/Layout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Calendar, Clock, MapPin, Users } from "lucide-react";
import { getCollection } from 'astro:content';

// Fetch events from TinaCMS
const allEvents = await getCollection('events');
const upcomingEvents = allEvents
  .filter(e => e.data.status === 'upcoming')
  .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime());
const pastEvents = allEvents
  .filter(e => e.data.status === 'past')
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Fallback to hardcoded if no CMS content (for demo)
const displayUpcoming = upcomingEvents.length > 0 ? upcomingEvents : [
  { id: 'event-0', data: { title: 'Monthly Food Distribution', date: new Date('2025-02-25'), location: 'Community Center, Vijayawada', image: 'https://images.unsplash.com/photo-1593113598332-cd288d649433?w=800&q=80', description: 'Join us as we serve nutritious meals to over 500 people in need.', status: 'upcoming' as const }, slug: 'monthly-food' },
  { id: 'event-1', data: { title: 'Annadanam Program', date: new Date('2025-03-08'), location: 'Temple Premises, Guntur', image: 'https://images.unsplash.com/photo-1532629345422-7515f3d16bb6?w=800&q=80', description: 'Special food distribution event in honor of Dokka Seethamma.', status: 'upcoming' as const }, slug: 'annadanam' },
];

const transparencyReports = [
  { month: 'January 2025', meals: 1200, volunteers: 45, expenses: '₹45,000' },
  { month: 'December 2024', meals: 2300, volunteers: 78, expenses: '₹86,000' },
  { month: 'November 2024', meals: 650, volunteers: 25, expenses: '₹24,000' },
];

const formatDate = (date: Date) => {
  return { 
    day: date.getDate(), 
    month: date.toLocaleString('en-US', { month: 'short' }), 
    full: date.toLocaleString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) 
  };
};
---

<Layout title="Events" description="View upcoming food distribution events and past activities.">
  <Navigation />

  <section class="relative pt-32 pb-16 lg:pb-24 bg-gradient-to-b from-golden-50 to-cream-50 dark:from-gray-900 dark:to-gray-800 transition-colors">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <Badge variant="outline" className="mb-4 text-golden-700 dark:text-golden-400 border-golden-300 dark:border-golden-500/50">Events</Badge>
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-earth-900 dark:text-gray-100 mb-4 sm:mb-6">Upcoming <span class="text-golden-600 dark:text-golden-400">Events</span></h1>
    </div>
  </section>

  <section class="py-16 lg:py-24 bg-white dark:bg-gray-800 transition-colors">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Custom Tabs -->
      <div class="tabs-container">
        <div class="flex justify-center gap-2 mb-8">
          <button class="tab-btn px-6 py-2 rounded-full border border-cream-200 dark:border-gray-600 data-[active=true]:bg-golden-500 data-[active=true]:text-white data-[active=true]:border-golden-500 transition-all text-earth-700 dark:text-gray-200 hover:bg-cream-100 dark:hover:bg-gray-700" data-tab="upcoming" data-active="true">Upcoming</button>
          <button class="tab-btn px-6 py-2 rounded-full border border-cream-200 dark:border-gray-600 data-[active=true]:bg-golden-500 data-[active=true]:text-white data-[active=true]:border-golden-500 transition-all text-earth-700 dark:text-gray-200 hover:bg-cream-100 dark:hover:bg-gray-700" data-tab="past">Past Events</button>
        </div>

        <div class="tab-content" data-content="upcoming">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            {displayUpcoming.map((event) => {
              const date = formatDate(event.data.date);
              return (
                <Card className="group overflow-hidden hover:shadow-xl transition-all dark:bg-gray-800 dark:border-gray-700">
                  <div class="aspect-video overflow-hidden">
                    <img src={event.data.image || 'https://images.unsplash.com/photo-1593113598332-cd288d649433?w=800&q=80'} alt={event.data.title} class="w-full h-full object-cover group-hover:scale-105 transition-transform max-w-full" />
                  </div>
                  <CardContent className="p-4 sm:p-6">
                    <div class="flex items-center gap-3 sm:gap-4 mb-3 sm:mb-4">
                      <div class="bg-golden-100 dark:bg-golden-900/30 rounded-lg p-2 sm:p-3 text-center min-w-[50px] sm:min-w-[60px]">
                        <div class="text-xl sm:text-2xl font-bold text-golden-600 dark:text-golden-400">{date.day}</div>
                        <div class="text-xs font-medium text-earth-600 dark:text-gray-400 uppercase">{date.month}</div>
                      </div>
                      <Badge className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 hover:bg-green-100 text-xs sm:text-sm">Upcoming</Badge>
                    </div>
                    <h3 class="text-base sm:text-xl font-bold text-earth-900 dark:text-gray-100 mb-1 sm:mb-2">{event.data.title}</h3>
                    <p class="text-earth-600 dark:text-gray-400 text-xs sm:text-sm mb-3 sm:mb-4 line-clamp-2">{event.data.description}</p>
                    <div class="space-y-1 sm:space-y-2 text-xs sm:text-sm text-earth-500 dark:text-gray-500 mb-3 sm:mb-4">
                      <div class="flex items-center gap-2"><Clock className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-golden-500 flex-shrink-0" /><span class="truncate">10:00 AM - 2:00 PM</span></div>
                      <div class="flex items-center gap-2"><MapPin className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-golden-500 flex-shrink-0" /><span class="truncate">{event.data.location}</span></div>
                    </div>
                    <a href={`/contact?event=${event.slug}`}><Button className="w-full min-h-[44px] bg-golden-500 hover:bg-golden-600 text-sm sm:text-base">Register Interest</Button></a>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        </div>

        <div class="tab-content hidden" data-content="past">
          <div class="grid md:grid-cols-2 gap-4">
            {pastEvents.length > 0 ? pastEvents.map((event) => {
              const date = formatDate(event.data.date);
              return (
                <Card className="group hover:shadow-md transition-all dark:bg-gray-800 dark:border-gray-700">
                  <CardContent className="p-6">
                    <div class="flex justify-between items-start mb-2">
                      <Badge variant="outline" className="text-golden-700 dark:text-golden-400 border-golden-300 dark:border-golden-500/50">{date.full}</Badge>
                      <span class="text-green-600 dark:text-green-400 text-sm font-medium flex items-center gap-1"><Users className="w-4 h-4" />Completed</span>
                    </div>
                    <h3 class="text-lg font-bold text-earth-900 dark:text-gray-100 mb-2">{event.data.title}</h3>
                    <p class="text-earth-600 dark:text-gray-400 text-sm">{event.data.description}</p>
                  </CardContent>
                </Card>
              );
            }) : (
              <div class="text-center py-12 text-earth-500 dark:text-gray-400">
                <p>No past events to display.</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="py-16 lg:py-24 bg-cream-50 dark:bg-gray-900 transition-colors" id="reports">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <Badge variant="outline" className="mb-4 text-golden-700 dark:text-golden-400 border-golden-300 dark:border-golden-500/50">Transparency Reports</Badge>
        <h2 class="text-3xl lg:text-4xl font-bold text-earth-900 dark:text-gray-100">Monthly <span class="text-golden-600 dark:text-golden-400">Reports</span></h2>
      </div>
      <Card className="overflow-hidden dark:bg-gray-800 dark:border-gray-700">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-golden-100 dark:bg-golden-900/30"><tr><th class="px-6 py-4 text-left text-sm font-semibold text-earth-900 dark:text-gray-100">Month</th><th class="px-6 py-4 text-left text-sm font-semibold text-earth-900 dark:text-gray-100">Meals</th><th class="px-6 py-4 text-left text-sm font-semibold text-earth-900 dark:text-gray-100">Volunteers</th><th class="px-6 py-4 text-left text-sm font-semibold text-earth-900 dark:text-gray-100">Expenses</th></tr></thead>
            <tbody class="divide-y divide-golden-200 dark:divide-gray-700">
              {transparencyReports.map((report) => (
                <tr class="hover:bg-golden-50/50 dark:hover:bg-gray-700/50"><td class="px-6 py-4 text-sm text-earth-900 dark:text-gray-100 font-medium">{report.month}</td><td class="px-6 py-4 text-sm text-earth-600 dark:text-gray-400">{report.meals.toLocaleString()}</td><td class="px-6 py-4 text-sm text-earth-600 dark:text-gray-400">{report.volunteers}</td><td class="px-6 py-4 text-sm text-earth-600 dark:text-gray-400">{report.expenses}</td></tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  </section>

  <section class="py-16 lg:py-24 bg-gradient-to-r from-earth-800 to-earth-900">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl lg:text-4xl font-bold text-white mb-6">Want to Host an Event?</h2>
      <a href="/contact"><Button size="lg" className="bg-golden-500 hover:bg-golden-600 text-white rounded-full px-8">Get in Touch</Button></a>
    </div>
  </section>

  <Footer />

  <script>
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        tabBtns.forEach(b => b.dataset.active = 'false');
        btn.dataset.active = 'true';
        tabContents.forEach(c => c.classList.add('hidden'));
        document.querySelector(`[data-content="${tab}"]`)?.classList.remove('hidden');
      });
    });
  </script>
</Layout>